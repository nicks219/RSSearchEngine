# История изменений:

#### v5.0.0:
#### закрыта critical уязвимость сервиса, фронт с react-router
* fix: закрыт доступ к бд снаружи докера
* fix: исправлены несколько багов на фронте и в логике работы с дампами
* fix: исправлен тестовый db-репозиторий с моком IQueryable
* upd: обновлены версии зависимостей
* upd: изменена структура проекта 
  - добавлены скрипты для npm
  - проект фронта убран из решения, редуцирован до файлов и разложен по виртуальным папкам (временный вариант)
* upd: начата чистка кода и изменение именований, в т.ч. контекста EF
* upd: добавлено использование SQLite для запуска интеграционных тестов и пример интеграционника
* ci: добавлен пробный пайплайн для прогона билда и тестов под .NET

#### v5.1.0
#### настройка локальной и удаленной разработки: подготовка CI/CD
* fix: фронт переработан для разработки с Vite 10.2.4 под Node 21.5.0 - npm 10.2.4 - React 17.0.0
  - время билда, количество зависимостей и артефактов сократилось на порядок
  - сборка проверена на младших версиях Node (18.19.0, 20.10.0)
* fix: поправлено использование кук совместно с CORS - модифицируется SameSite для соответсвия [**draft-west-cookie-incrementalism-00**](https://datatracker.ietf.org/doc/html/draft-west-cookie-incrementalism-00)
* upd: добавлен докерфайл для билда образа .NET + React
* upd: добавлен лаунчер среды разработки для JS (управление dev-сервером и браузером)
* ci: добавлен пробный пайплайн для прогона билда под Node.JS
* ci: добавлен пробный пайплайн для прогона билда образа сервиса с фронтом
* ci: добавлен пробный пайплайн для публикации докер-образа в GitHub Registry
* ci: тк на CI внутри билда .NET стал запускаться npm build, пререлизный JavaScript.Sdk был заменен на NET.Sdk и esproj исрправлен на csproj
* ci: для .NET использован базовый образ alpine, размер итогового образа сокращен в два раза
* cd: добавлен пробный пайплайн деплоя на удалённый сервер
* cd: добавлен пробный пайплайн для развертывания в кластере kubernetes k3s и манифесты для сервиса и mysql (в процессе проверки)

#### v5.1.1
#### настройка SSL
* fix: отключена модификация cookie для prod
* upd: https ready: изменен манифест ingress для поддержи DV SSL сертификата  
  kubectl create secret tls secret-tls --key=... --cert=...

#### v5.1.2
#### публикация API и переименование полей бд
* upd: переименованы файлы GitHub CI/CD
* upd: переименованы файлы манифестов K3S
* upd: проекты очищены от лишних комментариев
* upd: добавлены summary
* upd: исправлена структура проекта
* upd: отредактировано и опубликовано API
* upd: переименованы поля бд и дампа

#### v5.2.0
#### подъём версий
* upd: .NET8 + dockerfile
* upd: React 18 + Router 6
* upd: добавлен тестовый фреймворк для React: Vitest 1.2.2
* upd: запуск JS тестов на CI
* fix: подняты версии раннеров и SQLite (баг)
* fix: разделена конфигурация Vite для тестов и разработки

#### v5.2.x
#### клиент: правки по техдолгу
* 5.2.1 upd: конкретизированы типы TS
* 5.2.1 upd: компоненты клиента переписаны на функциональные
* 5.2.2 upd: переработанный глобальный стейт поставляется через контекст
* 5.2.2 upd: внешний стейт упрощен и разделен на recovery и common, компоненты разделены по файлам
* 5.2.3 upd: убраны стейт-машины из комопнентов Catalog и Read
* 5.2.4 business: мёрж дампа + расширение textbox
* 5.2.5 business: дополнен функционал сохранности данных + security-апдейт js + тесты vitest
* 5.2.6
  * business: добавлена политика авторизации, увеличен размер текста в заметке
  * observability: добавлены метрики и рейтлимитер на техническую ручку server_url/metrics
  * observability: добавлен Serilog
  * observability: добавлена трассировка в консоль для Debug
  * fix: исправлены угрозы безопасности (npm-пакеты), исправлен функционал запуска dev-сервера
* 5.2.7 front: модальное диалоговое окно 
* 5.2.x upd: настройка доступа по ssl-сертификату для нового домена notefinder.ru
   * k3s: добавлены и протестированы k3s-конфиги traefik для доступа по ip и https-доступа с адреса notefinder.ru
   * ssl: crt-бандл использован без root-сертификата: notefinder.noroot.crt
* 5.2.9
  * css: адаптивная grid-вёрстка для двух размеров экрана
  * upd: контроллер update целиком убран под авторизацию
  * upd: при перезагрузке страницы авторизация проверяется на сервере и кэшируется в local storage
  * dbs: переход на postgres: см [DEVLOG.md](src/Rsse.Data/DEVLOG.md)
  * test: интеграционные тесты в контейнерах локально и на пайплайне  
  * upd: добавлены ручки аплоада файла дампа и замены данных авторизации  
  * k3s: добавлен манифест на postgres  
* 5.2.9 security fix
  * fix: поставлен лимит на аплоад в 10МБ
  * fix: выгрузка дампов из рута закрыта под авторизацию, добавлена ручка даунлоада, расширение mysql-дампа заменено на .dump  
  * upd: дампы по умолчанию создаются для postgres, без применения DDL бд пересоздаётся средствами EF
* 6.0.0 `master` `на провреке: pre-1`
  * upd: NET9 | React19 | интеграционники с services: GitHub Actions | k3s PVC для сервиса 
  * upd: чистка sqlite файлов после локального запуска тестов
  * upd: для юнит-тестов используется мок AsyncQueryProvider из EFCore.Testing
  * k3s: билд self-contained под alpine:3.21 | глобализация отключена в csproj | используется для деплоя

  `develop/release/6.0.0-pre` `превью`
  * [сравнение ветки 6.0.0-pre с последним релизом k0.0.1 в github](https://github.com/nicks219/RSSearchEngine/compare/k0.0.1...6.0.0-preview)
  * рефакторинг времени жизни служб
  * рефакторинг функционала по слоям
  * рефакторинг тестов
  * upd: тяжелая для бд операция инициализации токенайзера теперь запускается строго однократно
  * upd: тесты в IDE теперь не ждут завершения очистки файлов, процесс очистки полностью отвязан
  * ci: pdb удаляются по флагу IsPublishing=true, локально остаются доступны  
  
  `develop/release/6.0.0-pre-1` `пре-релиз`
  * [сравнение ветки 6.0.0-pre-1 с последним релизом k0.0.1 в github](https://github.com/nicks219/RSSearchEngine/compare/k0.0.1...6.0.0-pre-release-1)
  * err: `fix` copy предварительно не очищает базу и падает на constraint ключей
  * err: `fix` создание дампа для новой песни удаляет dump.zip (когда создаёт только файлы без архива)
  * upd: увеличение тестового покрытия 
  * upd: рефакторинг архитектуры проектов (функционал/dto по слоям, убран service locator)
  * upd: `fix` в манифест **rsse-app-deployment** добавлена ручка `system/version` на **liveness/readiness** пробы  

  `в разработке` `рефакторинг API`
    * upd: проведён рефакторинг API, изменены пути и HTTP глаголы
      * дополнительно роуты прописаны в константы, из которых локально на билде генерируются константы для клиента (необходимо коммитать)
  * `в разработке`
    * [x] избавиться от лишних **nullable** в контексте
    * [ ] управлять managers через DI, переименовать 
    * [ ] отрефакторить IDataRepository
      * [x] сделать все методы асинхронными с потреблением данных по месту
        * добавлены nullable-типы (следует разобраться, отдавать null или пустые типы)
        * ReadNote(int noteId): сигнатура метода поправлена по существу
      * [x] избавиться от IQueryable
      * перенести методы подсчёта непосредственно в контракт
      * [x] использовать **IAsyncEnumerable** в перечислении по **ReadAllNotes** 
      * [x] рефакторинг методов, используемых только для тестов
    * [ ] code-style и небольшой рефакторинг: 
      * нейминг: managers -> services, убрать request/response из dto 
      * распилить dto CatalogItem по слоям
      * сделать dto иммутабельными (init only)
      * перенести в маппинг trim из CreateManager, checked/unchecked сделать bool
      * единообразно отсортировать методы


# Запланированные изменения:
* **БД**: ✅ перейти с MySQL на Postgres, функционал дампа дополнить раздельными миграциями схемы и данных
	  добавить k3s ресурсы для Postgres
* **Тесты**: юниты для JS, подготовить среду для E2E тестов, покрыть код автотестами, ✅ интеграционные (бд в контейнерах/services) на ci/cd
* **React**: ✅ упростить контейнер со стейтом, ~~подумать над применимостью в клиенте Flux/Redux~~
* **GitHub CI**: соединить пробные пайплайны в один, завязать публикацию образа на выпуск релиза
                 и использовать для него артефакты билда сервиса и фронта
* **GitHub CD**: подготовить варианты интеграции с высокодоступным кластером: сейчас сервис задеплоен на k3s
* **Permanent**: обеспечить дополнительную сохранность данных при необратимых действиях пользователя
* **UI**:
  * ✅ разделить верстку для мобильных устройств и десктопа, добавить modal-окна
    * вынести общие для всех устройств стили в отдельный файл CSS
    * ✅ добавить специфичные для устройств стили в отдельный файл CSS
  * вынести системный функционал в отдельную админку, переписать компонент с авторизацией
  * добавить понятный пользователю вывод ошибок
  * - [x] на стороне клиента: увеличить длину списка похожих до 20
  * базовый функционал - нечеткий поиск, отображение тегов - находится под авторизацией,  
    для демонстрации возможностей (а не только факта деплоя) следует создать компонент поиска/отображения тегов
* **Планы обновлений**: 
  * ✅ поднять версии до NET9 | Pg 17.4 | React 19
    * ✅ поправить пайплайн [ci.dotnet.build.yml](.github/workflows/ci.dotnet.build.yml)
    * ✅ поправить докерфайл для [Dockerfile-net-react](src/Dockerfile-net-react) и проверить пайплайн деплоя [cd.deploy.k3s.yml](.github/workflows/cd.deploy.k3s.yml)
  * ✅ подключи pvc для сервиса (ворнинг по поводу ключей)
  * ✅ используй на пайплайне services для интеграционных тестов
  * ✅ почисти сборку, убери лишние локализации
  * актуализировать версии до `6.0.0`: 
    * ✅ в package.json
    * ✅ зафиксировать в документации и [README.md](README.md)
    * зафиксировать в system/version
    * создать релиз
