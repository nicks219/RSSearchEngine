# переезд с MySql на Postgres

---
* в процессе переезда: читаем из Postgres, пишем в MySql и Postgres (откат при проблемах)
  * заводим и регистрируем MirrorRepo, который будет читать из одной базы и писать в обе
  * MirrorRepo резолвит три репозитория - один для чтения и два для записи
  * после завершения проверки оставляем один репо 
  
* get started: 
  * таблицы в бд будут созданы средствами EF, авторизация возможна по дефолтным значениям 
  * применяем дамп (backup_9 по дефолту) для mysql 
  * копируем данные на postgres, таблица с кредами будет перезаписана 
  * контекст для чтения выставляется в appsettings: DatabaseOptions:ReaderContext MySql|Postgres 
  * ... 

* выполнить: необходимо добавить и проверить k3s ресурсы: см [pg.k3s.md](../../.common/.private/pg.k3s.md)

---
* проблемы после копирования данных при добавлении новой записи, локально:
  * postgres не обновляет значение первичного ключа таблицы Note после копирования данных, падает на дубликате NoteId   
  * **решение**: **явно выставлять значения ключей** (во всех отношениях) после копирования данных  
  * далее: ошибка отсутствующего TagId в TagsToNotes при добавлении новой записи  
  * причина: в таблицу postgres не добавились "пустые" категории  
  * далее: запрос на postgres случайного текста возвращает значение по диапазону другого тега  
  * причина: для добавления связанных сущностей я полагался на поведение **AddRangeAsync**, явно добавляя только одну коллекцию   
  * **решение**: **явно добавлять все требуемые сущности**

---
* второстепенное:  
  * далее: не создавался дамп для нового текста тк отсутствовала временная директория
  * далее: после копирования и до перезагрузки сервиса не работает поиск по существующим/новым текстам  
    * по существующим исправил (инициализация токенизатора на копировании)  
    * по новым: возвращает null хотя в CreateNoteAndDumpAsync вызывается токенизатор  
      причина: CreateNote/DeleteNote возвращали сумму айдишников из двух бд  
  * дополнительно: на UI мы не получаем вывод ошибки, хотя в ответе есть "errorMessageResponse": "CreateModel CreateNote error"  
  * дополнительно: вызов автоинкремента: SELECT nextval('"Note_NoteId_seq"');  
  * ... 

---
* добавить тесты:
  * добавлена инфраструктура для прогона интеграционных тестов на контейнерах: локально и на github ci/cd  
  * тесты запускаются параллельно, параллелизм на уровне тестовых классов    
  * контексты с разными строками подключения не получалось изолировать тк в тестах IDataRepository запрашивал не scoped
  * инстансы sqlite изолированы по уникальным именам файлов с базой, следует добавить их удаление после прогона тестов  
  * сценарий: применение дампа для mysql - копирование данных в postgres - проверка crud для заметок
  * после копирования: не падает при вставке тега/заметки на дублировании (проверяем, что ключи выставляются правильно)
  * после копирования: есть "пустые" категории и после вставки заметки её можно получить по тегу, а также доступен её поисковый индекс
  * ... 
---
